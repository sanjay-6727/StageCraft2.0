{% extends "layout.html" %}
{% block content %}

<style>
/* ────────────────────────────────────────────────
   3D Glassmorphic Kanban Card - Stage Colored
───────────────────────────────────────────────── */

.parent {
    width: 100%;
    height: 320px;
    perspective: 1200px;
    margin-bottom: 1.5rem;
}

.card {
    height: 100%;
    border-radius: 40px;
    transition: all 0.6s ease-in-out;
    transform-style: preserve-3d;
    box-shadow:
        rgba(30, 30, 60, 0) 40px 50px 25px -40px,
        rgba(30, 30, 60, 0.2) 0px 25px 25px -5px;
    cursor: pointer;
    overflow: hidden;
    position: relative;
}

.glass {
    transform-style: preserve-3d;
    position: absolute;
    inset: 10px;
    border-radius: 45px;
    border-top-left-radius: 100%;
    background: linear-gradient(
        0deg,
        rgba(255, 255, 255, 0.15) 0%,
        rgba(255, 255, 255, 0.65) 100%
    );
    transform: translate3d(0px, 0px, 30px);
    border-right: 1px solid rgba(255, 255, 255, 0.4);
    border-bottom: 1px solid rgba(255, 255, 255, 0.4);
    transition: all 0.6s ease-in-out;
    pointer-events: none;
}

.content {
    padding: 80px 35px 100px 35px;
    transform: translate3d(0, 0, 36px);
    position: relative;
    z-index: 2;
}

.content .title {
    display: block;
    color: #1e1b4b;
    font-weight: 800;
    font-size: 1.35rem;
    line-height: 1.3;
    margin-bottom: 0.75rem;
}

.content .text {
    display: block;
    color: rgba(30, 27, 75, 0.88);
    font-size: 0.95rem;
    line-height: 1.45;
    opacity: 0.92;
}

.stage-label {
    position: absolute;
    top: 20px;
    right: 24px;
    background: rgba(255,255,255,0.28);
    backdrop-filter: blur(6px);
    color: white;
    font-size: 0.82rem;
    font-weight: 600;
    padding: 0.4rem 1rem;
    border-radius: 999px;
    z-index: 3;
    transform: translate3d(0,0,50px);
}

/* Hover tilt effect */
.parent:hover .card {
    transform: rotate3d(1, -1, 0, 22deg);
    box-shadow:
        rgba(30, 30, 60, 0.38) 30px 50px 25px -35px,
        rgba(30, 30, 60, 0.20) 0px 30px 35px 0px;
}

.parent:hover .card .glass {
    transform: translate3d(0px, 0px, 45px);
}

/* Mobile adjustment */
@media (max-width: 768px) {
    .parent { height: 280px; }
    .content { padding: 70px 28px 90px 28px; }
    .content .title { font-size: 1.22rem; }
    .content .text  { font-size: 0.92rem; }
}

/* ────────────────────────────────────────────────
   Stage-specific gradient backgrounds
───────────────────────────────────────────────── */
.stage-Requirement  .card { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
.stage-Design       .card { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); }
.stage-Implementation .card { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
.stage-Testing      .card { background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); }
.stage-Release      .card { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); }

/* Darker text for better contrast on brighter stages */
.stage-Design       .content .title,
.stage-Design       .content .text,
.stage-Implementation .content .title,
.stage-Implementation .content .text {
    color: #1e293b;
}
</style>

<!-- Quick Metrics Dashboard -->
<div class="row g-3 mb-5" id="quickMetrics"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-semibold mb-0">SDLC Development Board</h3>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createModal">
        <i class="fas fa-plus me-1"></i> New Work Item
    </button>
</div>

<div class="position-relative">
    <div class="row g-3" id="board"></div>
    <div id="loading" class="position-absolute top-50 start-50 translate-middle d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- Create Modal (unchanged) -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createModalLabel">Create New Work Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createForm">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" required placeholder="Enter title...">
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3" placeholder="Optional description..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Create</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Item Detail Modal (unchanged) -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header" id="modalHeader">
                <h5 class="modal-title" id="itemModalLabel">Work Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalContent">Loading...</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Regression Modal (unchanged) -->
<div class="modal fade" id="regressionModal" tabindex="-1" aria-labelledby="regressionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="regressionModalLabel">Regress Stage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Please provide a reason for moving this item back one stage.</p>
                <form id="regressionForm">
                    <div class="mb-3">
                        <label for="regressionReason" class="form-label">Reason <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="regressionReason" rows="3" required placeholder="e.g., Found critical bug during testing..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-warning w-100">Confirm Regression</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// ────────────────────────────────────────────────
//  Main board logic with stage-colored 3D cards
// ────────────────────────────────────────────────

const STAGES = ["Requirement", "Design", "Implementation", "Testing", "Release"];
let currentItemIdForRegression = null;

async function loadBoard() {
    const loading = document.getElementById('loading');
    const board = document.getElementById('board');
    const quickMetrics = document.getElementById('quickMetrics');

    loading.classList.remove('d-none');
    board.innerHTML = '';
    quickMetrics.innerHTML = '<div class="col-12 text-center py-4"><div class="spinner-border text-primary"></div></div>';

    try {
        const boardRes = await fetch('/board');
        if (!boardRes.ok) throw new Error('Failed to load board');
        const boardData = await boardRes.json();

        const metricsRes = await fetch('/metrics');
        if (!metricsRes.ok) throw new Error('Failed to load metrics');
        const metricsData = await metricsRes.json();

        // Quick metrics (unchanged)
        let metricsHtml = '';
        for (const stage in metricsData.items_per_stage) {
            const count = metricsData.items_per_stage[stage];
            metricsHtml += `
                <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                    <div class="card shadow-sm text-center h-100 border-0">
                        <div class="card-body py-3 px-2">
                            <h6 class="text-uppercase text-muted mb-1 small fw-semibold">${stage}</h6>
                            <h4 class="fw-bold mb-0">${count}</h4>
                        </div>
                    </div>
                </div>
            `;
        }
        quickMetrics.innerHTML = metricsHtml;

        // Kanban columns
        Object.keys(boardData).forEach(stage => {
            const items = boardData[stage];
            const col = document.createElement('div');
            col.className = 'col-12 col-md-6 col-lg';

            let cardsHtml = '';
            if (items.length === 0) {
                cardsHtml = `
                    <div class="empty-state py-5 text-center">
                        <i class="fas fa-inbox text-muted fa-3x mb-3"></i>
                        <h6 class="text-muted mb-2">No items in ${stage}</h6>
                        <small class="text-muted">Create a new work item to start the SDLC process.</small>
                    </div>
                `;
            } else {
                cardsHtml = items.map(item => `
                    <div class="parent" onclick="openItem(${item.id})">
                        <div class="card">
                            <div class="stage-label">${stage}</div>
                            <div class="glass"></div>
                            <div class="content">
                                <span class="title">${item.title}</span>
                                <span class="text">
                                    ${item.description_snippet 
                                        ? item.description_snippet.substring(0, 110) + (item.description_snippet.length > 110 ? '...' : '')
                                        : 'No description provided'}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            col.innerHTML = `
                <div class="stage-column stage-${stage}">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="mb-0 fw-semibold">${stage}</h5>
                        <span class="badge rounded-pill bg-dark text-white">${items.length}</span>
                    </div>
                    ${cardsHtml}
                </div>
            `;

            board.appendChild(col);
        });
    } catch (err) {
        quickMetrics.innerHTML = '';
        board.innerHTML = `<div class="alert alert-danger">Could not load data: ${err.message}</div>`;
    } finally {
        loading.classList.add('d-none');
    }
}

// ────────────────────────────────────────────────
//  The rest of your script remains unchanged
// ────────────────────────────────────────────────

async function openItem(id) { /* ... your existing code ... */ }
async function moveForward(id, currentStage) { /* ... */ }
function showRegressionModal(id) { /* ... */ }

document.getElementById('regressionForm').addEventListener('submit', async e => { /* ... */ });
document.getElementById('createForm').addEventListener('submit', async e => { /* ... */ });

window.addEventListener('load', loadBoard);
</script>

{% endblock %}