{% extends "layout.html" %}
{% block content %}

<!-- Tailwind + Fonts + Material Symbols -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">

<style>
    body {
        font-family: 'Manrope', system-ui, -apple-system, sans-serif;
    }

    .glass {
        background: rgba(255, 255, 255, 0.68);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.28);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.10);
    }

    [data-bs-theme="dark"] .glass {
        background: rgba(30, 41, 59, 0.58);
        border-color: rgba(255,255,255,0.09);
        box-shadow: 0 8px 32px rgba(0,0,0,0.40);
    }

    [data-bs-theme="dark"] .text-dark {
        color: white !important;
    }

    [data-bs-theme="dark"] .text-muted {
        color: #9ca3af !important;
    }

    .theme-btn {
        transition: all 0.25s ease;
    }

    .theme-btn.active {
        background-color: #0d6efd;
        color: white !important;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .theme-btn:hover:not(.active) {
        background-color: rgba(13, 110, 253, 0.08);
    }

    .kanban-column {
        min-width: 320px;
        width: 320px;
        min-height: calc(100vh - 280px);
    }

    .glow-bg {
        position: absolute;
        inset: 0;
        border-radius: 1.5rem;
        filter: blur(48px);
        opacity: 0.16;
        z-index: -1;
    }

    .stage-pill {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: 600;
    }

    .custom-scrollbar::-webkit-scrollbar {
        height: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
    [data-bs-theme="dark"] .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #475569;
    }

    .wip-limit-exceeded {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
    }

    .kanban-card {
        transition: all 0.2s ease;
    }
    .kanban-card[draggable="true"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.12);
    }
    .drag-over {
        background: rgba(59, 130, 246, 0.15) !important;
        border: 2px dashed #3b82f6 !important;
    }
</style>

<div class="container-fluid px-4 py-5">

    <!-- Header + Theme Controls + Search -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h3 class="fw-bold mb-1">SDLC Development Board</h3>
            <div class="text-muted small">Enforced workflow • {{ STAGES|length }} stages</div>
        </div>

        <div class="d-flex align-items-center gap-2 flex-wrap">
            <input type="search" id="boardSearch" class="form-control rounded-pill px-4" placeholder="Search items..." style="min-width: 240px;">

            <button id="btnLight" class="btn btn-outline-secondary theme-btn px-4 d-flex align-items-center gap-2 active">
                <span class="material-symbols-outlined">light_mode</span>
                Light
            </button>

            <button id="btnDark" class="btn btn-outline-secondary theme-btn px-4 d-flex align-items-center gap-2">
                <span class="material-symbols-outlined">dark_mode</span>
                Dark
            </button>

            <button class="btn btn-primary rounded-pill px-4 shadow d-flex align-items-center gap-2 ms-2"
                    data-bs-toggle="modal" data-bs-target="#createModal">
                <span class="material-symbols-outlined">add</span>
                New Work Item
            </button>
        </div>
    </div>

    <!-- Quick Metrics Dashboard -->
    <div class="row g-3 mb-5" id="quickMetrics"></div>

    <!-- Kanban Board -->
    <div class="position-relative">
        <div class="d-flex flex-nowrap gap-4 overflow-x-auto pb-5 custom-scrollbar" id="board"></div>

        <div id="loading" class="position-absolute top-50 start-50 translate-middle d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

</div>

<!-- MODALS -->

<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="createModalLabel">Create New Work Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createForm">
                    <div class="mb-3">
                        <label for="title" class="form-label fw-medium">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" required placeholder="Enter title...">
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label fw-medium">Priority</label>
                        <select class="form-select" id="priority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label fw-medium">Description</label>
                        <textarea class="form-control" id="description" rows="4" placeholder="Optional description..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold">Create Item</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content glass shadow-xl">
            <div class="modal-header border-0" id="modalHeader">
                <h5 class="modal-title fw-bold" id="itemModalLabel">Work Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalContent">
                Loading...
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="regressionModal" tabindex="-1" aria-labelledby="regressionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="regressionModalLabel">Regress to Previous Stage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Please explain why this item needs to move backward.</p>
                <form id="regressionForm">
                    <div class="mb-3">
                        <label for="regressionReason" class="form-label fw-medium">Reason <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="regressionReason" rows="4" required placeholder="e.g., Critical defect discovered during testing..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-warning w-100 rounded-pill py-2 fw-bold">Confirm Regression</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
// ────────────────────────────────────────────────
// THEME SWITCHING
// ────────────────────────────────────────────────

function setTheme(theme) {
    document.documentElement.setAttribute('data-bs-theme', theme);
    localStorage.setItem('theme', theme);
    document.getElementById('btnLight').classList.toggle('active', theme === 'light');
    document.getElementById('btnDark').classList.toggle('active', theme === 'dark');
}

document.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    setTheme(saved || (prefersDark ? 'dark' : 'light'));

    document.getElementById('btnLight').addEventListener('click', () => setTheme('light'));
    document.getElementById('btnDark').addEventListener('click', () => setTheme('dark'));
});

// ────────────────────────────────────────────────
// BOARD DATA & CONFIG
// ────────────────────────────────────────────────

const STAGES = ["Requirement", "Design", "Implementation", "Testing", "Release"];

const stageColors = {
    "Requirement":    { light: "#c4b5fd", dark: "#7c3aed", glow: "#a78bfa" },
    "Design":         { light: "#6ee7b7", dark: "#10b981", glow: "#34d399" },
    "Implementation": { light: "#fcd34d", dark: "#d97706", glow: "#fbbf24" },
    "Testing":        { light: "#fca5a5", dark: "#ef4444", glow: "#f87171" },
    "Release":        { light: "#93c5fd", dark: "#3b82f6", glow: "#60a5fa" }
};

const wipLimits = {
    "Requirement": 8,
    "Design": 5,
    "Implementation": 6,
    "Testing": 7,
    "Release": 3
};

const priorityColors = {
    "Low":      "bg-secondary text-white",
    "Medium":   "bg-info text-white",
    "High":     "bg-warning text-dark",
    "Critical": "bg-danger text-white"
};

function getStageColorClass(stage) {
    const map = { "Requirement": "info", "Design": "success", "Implementation": "warning", "Testing": "danger", "Release": "primary" };
    return map[stage] || "secondary";
}

// ────────────────────────────────────────────────
// BOARD LOADING
// ────────────────────────────────────────────────

async function loadBoard() {
    const loading = document.getElementById('loading');
    const board = document.getElementById('board');
    const quickMetrics = document.getElementById('quickMetrics');

    loading.classList.remove('d-none');
    board.innerHTML = '';
    quickMetrics.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>';

    try {
        const boardRes = await fetch('/board');
        if (!boardRes.ok) throw new Error('Failed to load board');
        const boardData = await boardRes.json();

        const metricsRes = await fetch('/metrics');
        if (!metricsRes.ok) throw new Error('Failed to load metrics');
        const metricsData = await metricsRes.json();

        // Metrics
        let metricsHtml = '';
        Object.entries(metricsData.items_per_stage).forEach(([stage, count], i) => {
            const colors = ["purple", "emerald", "amber", "rose", "blue"];
            const icons  = ["assignment", "brush", "code", "bug_report", "rocket_launch"];
            metricsHtml += `
                <div class="col-6 col-md-4 col-lg-3 col-xl">
                    <div class="glass rounded-3xl p-4 shadow-sm border-l-4 border-l-${colors[i]}-500">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-xs fw-bold text-uppercase text-muted mb-1">${stage}</div>
                                <div class="fs-3 fw-extrabold text-dark">${count}</div>
                            </div>
                            <span class="material-symbols-outlined text-${colors[i]}-600 fs-3">
                                ${icons[i]}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
        quickMetrics.innerHTML = metricsHtml;

        // Board columns
        board.innerHTML = '';
        STAGES.forEach(stage => {
            const items = boardData[stage] || [];
            const color = stageColors[stage] || {light:"#e2e8f0", dark:"#475569", glow:"#94a3b8"};
            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
            const limit = wipLimits[stage] || null;
            const exceeded = limit && items.length > limit;

            let cardsHtml = items.length === 0 ? `
                <div class="text-center py-10 text-muted">
                    <span class="material-symbols-outlined fs-1 opacity-50">inbox</span>
                    <p class="mt-3 small">No items yet</p>
                </div>
            ` : items.map(item => `
                <div class="glass rounded-2xl p-4 mb-3 shadow hover:shadow-xl transition-all duration-200 cursor-pointer group kanban-card"
                     data-id="${item.id}"
                     draggable="true"
                     onclick="openItem(${item.id})">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <span class="stage-pill bg-${getStageColorClass(stage)}/10 text-${getStageColorClass(stage)}">
                            ${stage}
                        </span>
                        <span class="material-symbols-outlined text-muted opacity-60 group-hover:opacity-100">more_horiz</span>
                    </div>
                    <div class="mb-2">
                        <span class="badge ${priorityColors[item.priority || 'Medium']} me-2">${item.priority || 'Medium'}</span>
                    </div>
                    <h5 class="fw-bold mb-2 line-clamp-2 text-dark">${item.title}</h5>
                    <p class="small text-muted mb-0 line-clamp-3">${item.description_snippet || 'No description provided'}</p>
                </div>
            `).join('');

            const col = document.createElement('div');
            col.className = 'kanban-column flex-shrink-0';
            col.innerHTML = `
                <div class="position-relative glass rounded-3xl p-4 border border-slate-200/60 shadow-sm h-100 ${exceeded ? 'wip-limit-exceeded' : ''}">
                    <div class="glow-bg bg-[${color.glow}]"></div>
                    <div class="d-flex align-items-center justify-content-between mb-4 ${exceeded ? 'text-danger' : ''}">
                        <div class="d-flex align-items-center gap-2">
                            <span class="w-3 h-3 rounded-circle bg-[${isDark ? color.dark : color.light}]"></span>
                            <h5 class="fw-bold mb-0 text-dark">${stage}</h5>
                            ${limit ? `<small class="text-muted ms-2">WIP: ${items.length}/${limit}</small>` : ''}
                        </div>
                        <span class="badge ${exceeded ? 'bg-danger' : 'bg-dark'} text-white rounded-pill px-3 py-1 fw-medium">
                            ${items.length}
                        </span>
                    </div>
                    <div class="drop-zone overflow-y-auto custom-scrollbar" style="min-height: 200px; max-height: calc(100vh - 280px);">
                        ${cardsHtml}
                    </div>
                </div>
            `;
            board.appendChild(col);
        });

        initDragAndDrop();
        initSearch();

    } catch (err) {
        quickMetrics.innerHTML = '';
        board.innerHTML = `<div class="alert alert-danger w-100 text-center p-5">Could not load data: ${err.message}</div>`;
    } finally {
        loading.classList.add('d-none');
    }
}

// ────────────────────────────────────────────────
// DRAG & DROP
// ────────────────────────────────────────────────

let draggedCard = null;

function initDragAndDrop() {
    document.querySelectorAll('.kanban-card').forEach(card => {
        card.addEventListener('dragstart', e => {
            draggedCard = card;
            setTimeout(() => card.style.opacity = '0.5', 0);
            e.dataTransfer.effectAllowed = 'move';
        });

        card.addEventListener('dragend', () => {
            setTimeout(() => {
                if (draggedCard) draggedCard.style.opacity = '1';
                draggedCard = null;
            }, 100);
            document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('drag-over'));
        });
    });

    document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.addEventListener('dragover', e => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            zone.classList.add('drag-over');
        });

        zone.addEventListener('dragleave', () => {
            zone.classList.remove('drag-over');
        });

        zone.addEventListener('drop', e => {
            e.preventDefault();
            zone.classList.remove('drag-over');

            if (!draggedCard) return;

            const newColumn = zone.closest('.kanban-column');
            const newStageEl = newColumn.querySelector('h5.fw-bold');
            const newStage = newStageEl?.textContent.trim();

            if (!newStage || !STAGES.includes(newStage)) return;

            const itemId = draggedCard.dataset.id;
            if (!itemId) return;

            // Optimistic UI update
            zone.appendChild(draggedCard);

            // TODO: call backend
            // fetch(`/workitems/${itemId}/move`, {
            //     method: 'PATCH',
            //     headers: {'Content-Type': 'application/json'},
            //     body: JSON.stringify({ new_stage: newStage })
            // }).catch(err => {
            //     console.error(err);
            //     alert('Move failed');
            //     loadBoard(); // rollback
            // });

            updateColumnCounts();
        });
    });
}

function updateColumnCounts() {
    document.querySelectorAll('.kanban-column').forEach(col => {
        const badge = col.querySelector('.badge.rounded-pill');
        const count = col.querySelectorAll('.kanban-card').length;
        if (badge) badge.textContent = count;

        const wipText = col.querySelector('small.text-muted');
        if (wipText) {
            const limit = parseInt(wipText.textContent.match(/\/(\d+)/)?.[1] || 0);
            wipText.closest('.d-flex').classList.toggle('text-danger', count > limit);
            col.querySelector('.position-relative').classList.toggle('wip-limit-exceeded', count > limit);
            badge?.classList.toggle('bg-danger', count > limit);
            badge?.classList.toggle('bg-dark', count <= limit);
        }
    });
}

// ────────────────────────────────────────────────
// SEARCH / FILTER
// ────────────────────────────────────────────────

function initSearch() {
    const searchInput = document.getElementById('boardSearch');
    if (!searchInput) return;

    searchInput.addEventListener('input', e => {
        const term = e.target.value.toLowerCase().trim();
        document.querySelectorAll('.kanban-card').forEach(card => {
            const title = card.querySelector('h5')?.textContent.toLowerCase() || '';
            const desc  = card.querySelector('p.small')?.textContent.toLowerCase() || '';
            card.style.display = (title.includes(term) || desc.includes(term)) ? '' : 'none';
        });
    });
}

// ────────────────────────────────────────────────
// MODAL & FORM HANDLERS (placeholders)
// ────────────────────────────────────────────────

async function openItem(id) {
    console.log(`Opening item ${id}`);
    const modal = new bootstrap.Modal(document.getElementById('itemModal'));
    modal.show();
    // TODO: fetch(`/workitems/${id}`) and populate modalContent
}

document.getElementById('createForm')?.addEventListener('submit', e => {
    e.preventDefault();
    const title = document.getElementById('title').value.trim();
    const priority = document.getElementById('priority').value;
    const desc = document.getElementById('description').value.trim();

    if (!title) return;

    // TODO: POST to backend
    // fetch('/workitems', {
    //     method: 'POST',
    //     headers: {'Content-Type': 'application/json'},
    //     body: JSON.stringify({ title, priority, description: desc })
    // }).then(() => {
    //     bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
    //     loadBoard();
    // });

    alert(`Creating: ${title} (${priority})`);
    bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
    loadBoard(); // simulate refresh
});

document.getElementById('regressionForm')?.addEventListener('submit', e => {
    e.preventDefault();
    const reason = document.getElementById('regressionReason').value.trim();
    if (reason) {
        alert(`Regression confirmed. Reason: ${reason}`);
        bootstrap.Modal.getInstance(document.getElementById('regressionModal')).hide();
    }
});

// Initial load
document.addEventListener('DOMContentLoaded', loadBoard);
</script>

{% endblock %}