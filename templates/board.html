{% extends "layout.html" %}
{% block content %}

<!-- Chart.js for pie chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Tailwind + Fonts + Material Symbols -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">

<style>
    body {
        font-family: 'Manrope', system-ui, -apple-system, sans-serif;
    }

    .glass {
        background: rgba(255, 255, 255, 0.68);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.28);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.10);
    }

    [data-bs-theme="dark"] .glass {
        background: rgba(30, 41, 59, 0.58);
        border-color: rgba(255, 255, 255, 0.09);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.40);
    }

    [data-bs-theme="dark"] .text-dark {
        color: white !important;
    }

    [data-bs-theme="dark"] .text-muted {
        color: #9ca3af !important;
    }

    .theme-btn {
        transition: all 0.25s ease;
    }

    .theme-btn.active {
        background-color: #0d6efd;
        color: white !important;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .theme-btn:hover:not(.active) {
        background-color: rgba(13, 110, 253, 0.08);
    }

    .kanban-column {
        min-width: 320px;
        width: 320px;
        min-height: calc(100vh - 280px);
    }

    .glow-bg {
        position: absolute;
        inset: 0;
        border-radius: 1.5rem;
        filter: blur(48px);
        opacity: 0.16;
        z-index: -1;
    }

    .stage-pill {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: 600;
    }

    .custom-scrollbar::-webkit-scrollbar {
        height: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    [data-bs-theme="dark"] .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #475569;
    }

    .wip-limit-exceeded {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
    }

    .kanban-card {
        transition: all 0.2s ease;
    }

    .kanban-card[draggable="true"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
    }

    .drag-over {
        background: rgba(59, 130, 246, 0.15) !important;
        border: 2px dashed #3b82f6 !important;
    }
</style>

<div class="container-fluid px-4 py-5">

    <!-- Header + Search -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h3 class="fw-bold mb-1">SDLC Enterprise Board</h3>
            <div class="text-muted small">Strict Stage-Gate Enforcement • {{ STAGES|length }} stages</div>
        </div>

        <div class="d-flex align-items-center gap-3">
            <div class="input-group drop-shadow-sm w-auto">
                <span class="input-group-text bg-white border-end-0" id="roleIcon">
                    <span class="material-symbols-outlined fs-6 text-muted">badge</span>
                </span>
                <select id="userRole" class="form-select border-start-0 ps-0 fw-bold" style="background-color: white;">
                    <option value="Admin">Admin</option>
                    <option value="Manager">Manager</option>
                    <option value="Architect" selected>Architect</option>
                    <option value="Developer">Developer</option>
                    <option value="Tester">Tester</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Enhanced Metrics Dashboard -->
    <section class="mb-5">
        <h4 class="fw-bold mb-4 text-dark">Workflow Metrics Overview</h4>
        <div class="row g-4">

            <!-- Pie Chart -->
            <div class="col-12 col-lg-6">
                <div class="glass rounded-4 p-4 shadow-sm h-100">
                    <h6 class="fw-semibold mb-3 text-dark">Items by Stage</h6>
                    <div style="height: 260px;">
                        <canvas id="stagePieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Icon cards + compact counts -->
            <div class="col-12 col-lg-6">
                <div class="row g-3" id="quickMetrics"></div>
                <div class="row g-3 mt-3" id="stageCountCards"></div>
            </div>

        </div>
    </section>

    <!-- Kanban Board -->
    <div class="position-relative">
        <div class="d-flex flex-nowrap gap-4 overflow-x-auto pb-5 custom-scrollbar" id="board"></div>

        <div id="loading" class="position-absolute top-50 start-50 translate-middle d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

</div>

<!-- MODALS (unchanged) -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="createModalLabel">Create New Work Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createForm">
                    <div class="mb-3">
                        <label for="title" class="form-label fw-medium">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" required placeholder="Enter title...">
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label fw-medium">Priority</label>
                        <select class="form-select" id="priority">
                            <option value="Low">Low</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="assignee" class="form-label fw-medium">Assignee</label>
                        <input type="text" class="form-control" id="assignee" placeholder="e.g. John Doe">
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label fw-medium">Description</label>
                        <textarea class="form-control" id="description" rows="4"
                            placeholder="Optional description..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold">Create Item</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content glass shadow-xl">
            <div class="modal-header border-0" id="modalHeader">
                <h5 class="modal-title fw-bold" id="itemModalLabel">Work Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalContent">
                Loading...
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                    data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="regressionModal" tabindex="-1" aria-labelledby="regressionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="regressionModalLabel">Regress to Previous Stage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Please explain why this item needs to move backward.</p>
                <form id="regressionForm">
                    <div class="mb-3">
                        <label for="regressionReason" class="form-label fw-medium">Reason <span
                                class="text-danger">*</span></label>
                        <textarea class="form-control" id="regressionReason" rows="4" required
                            placeholder="e.g., Critical defect discovered during testing..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-warning w-100 rounded-pill py-2 fw-bold">Confirm
                        Regression</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

<script>
    // ────────────────────────────────────────────────
    // BOARD DATA & CONFIG
    // ────────────────────────────────────────────────

    const STAGES = ["Requirement", "Design", "Implementation", "Testing", "Release"];

    const stageColors = {
        "Requirement": { light: "#c4b5fd", dark: "#7c3aed", glow: "#a78bfa" },
        "Design": { light: "#6ee7b7", dark: "#10b981", glow: "#34d399" },
        "Implementation": { light: "#fcd34d", dark: "#d97706", glow: "#fbbf24" },
        "Testing": { light: "#fca5a5", dark: "#ef4444", glow: "#f87171" },
        "Release": { light: "#93c5fd", dark: "#3b82f6", glow: "#60a5fa" }
    };

    const wipLimits = {
        "Requirement": 8,
        "Design": 5,
        "Implementation": 6,
        "Testing": 7,
        "Release": 3
    };

    const priorityColors = {
        "Low": "bg-secondary text-white",
        "Medium": "bg-info text-white",
        "High": "bg-warning text-dark",
        "Critical": "bg-danger text-white"
    };

    function getStageColorClass(stage) {
        const map = { "Requirement": "info", "Design": "success", "Implementation": "warning", "Testing": "danger", "Release": "primary" };
        return map[stage] || "secondary";
    }

    // ────────────────────────────────────────────────
    // BOARD LOADING
    // ────────────────────────────────────────────────

    async function loadBoard() {
        const loading = document.getElementById('loading');
        const board = document.getElementById('board');
        const quickMetrics = document.getElementById('quickMetrics');
        const stageCountCards = document.getElementById('stageCountCards');

        loading.classList.remove('d-none');
        board.innerHTML = '';
        if (quickMetrics) quickMetrics.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>';
        if (stageCountCards) stageCountCards.innerHTML = '';

        try {
            const boardRes = await fetch('/board');
            if (!boardRes.ok) throw new Error('Failed to load board');
            const boardData = await boardRes.json();

            const metricsRes = await fetch('/metrics');
            if (!metricsRes.ok) throw new Error('Failed to load metrics');
            const metricsData = await metricsRes.json();

            // ── Metrics ────────────────────────────────────────────────────────────

            // 1. Icon-based glass cards
            let metricsHtml = '';
            Object.entries(metricsData.items_per_stage).forEach(([stage, count], i) => {
                const colors = ["purple", "emerald", "amber", "rose", "blue"];
                const icons = ["assignment", "brush", "code", "bug_report", "rocket_launch"];
                metricsHtml += `
                <div class="col-6 col-md-4 col-lg-6 col-xl-4">
                    <div class="glass rounded-3xl p-4 shadow-sm border-l-4 border-l-${colors[i]}-500">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-xs fw-bold text-uppercase text-muted mb-1">${stage}</div>
                                <div class="fs-3 fw-extrabold text-dark">${count}</div>
                            </div>
                            <span class="material-symbols-outlined text-${colors[i]}-600 fs-3">
                                ${icons[i]}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            });
            if (quickMetrics) quickMetrics.innerHTML = metricsHtml;

            // 2. Pie Chart
            const pieCtx = document.getElementById('stagePieChart');
            if (window.stagePieChartInstance) {
                window.stagePieChartInstance.destroy();
            }
            window.stagePieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(metricsData.items_per_stage),
                    datasets: [{
                        data: Object.values(metricsData.items_per_stage),
                        backgroundColor: ['#c4b5fd', '#6ee7b7', '#fcd34d', '#fca5a5', '#93c5fd'],
                        borderColor: ['#7c3aed', '#10b981', '#d97706', '#ef4444', '#3b82f6'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#e2e8f0' : '#334155',
                                font: { size: 13 }
                            }
                        }
                    }
                }
            });

            // 3. Compact count cards
            let countCardsHtml = '';
            Object.entries(metricsData.items_per_stage).forEach(([stage, count]) => {
                countCardsHtml += `
                <div class="col-6 col-sm-4 col-md-3">
                    <div class="glass rounded-3 p-3 text-center shadow-sm">
                        <div class="small text-muted fw-medium">${stage}</div>
                        <div class="fs-4 fw-bold text-dark mt-1">${count}</div>
                    </div>
                </div>
            `;
            });
            if (stageCountCards) stageCountCards.innerHTML = countCardsHtml;

            // ── Board Columns ──────────────────────────────────────────────────────
            board.innerHTML = '';
            STAGES.forEach(stage => {
                const items = boardData[stage] || [];
                const color = stageColors[stage] || { light: "#e2e8f0", dark: "#475569", glow: "#94a3b8" };
                const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                const limit = wipLimits[stage] || null;
                const exceeded = limit && items.length > limit;

                let cardsHtml = items.length === 0 ? `
                <div class="text-center py-10 text-muted">
                    <span class="material-symbols-outlined fs-1 opacity-50">inbox</span>
                    <p class="mt-3 small">No items yet</p>
                </div>
            ` : items.map(item => `
                <div class="glass rounded-2xl p-4 mb-3 shadow hover:shadow-xl transition-all duration-200 cursor-pointer group kanban-card"
                     data-id="${item.id}"
                     draggable="true"
                     onclick="openItem(${item.id})">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <span class="stage-pill bg-${getStageColorClass(stage)}/10 text-${getStageColorClass(stage)}">
                            ${stage}
                        </span>
                        <span class="material-symbols-outlined text-muted opacity-60 group-hover:opacity-100">more_horiz</span>
                    </div>
                    <div class="mb-2 d-flex justify-content-between align-items-center">
                        <span class="badge ${priorityColors[item.priority || 'Medium']} me-2">${item.priority || 'Medium'}</span>
                        <span class="small text-muted d-flex align-items-center"><span class="material-symbols-outlined fs-6 me-1">person</span> ${item.assignee || 'Unassigned'}</span>
                    </div>
                    <h5 class="fw-bold mb-2 line-clamp-2 text-dark">${item.title}</h5>
                    <p class="small text-muted mb-0 line-clamp-3">${item.description_snippet || 'No description provided'}</p>
                </div>
            `).join('');

                const col = document.createElement('div');
                col.className = 'kanban-column flex-shrink-0';
                col.innerHTML = `
                <div class="position-relative glass rounded-3xl p-4 border border-slate-200/60 shadow-sm h-100 ${exceeded ? 'wip-limit-exceeded' : ''}">
                    <div class="glow-bg bg-[${color.glow}]"></div>
                    <div class="d-flex align-items-center justify-content-between mb-4 ${exceeded ? 'text-danger' : ''}">
                        <div class="d-flex align-items-center gap-2">
                            <span class="w-3 h-3 rounded-circle bg-[${isDark ? color.dark : color.light}]"></span>
                            <h5 class="fw-bold mb-0 text-dark">${stage}</h5>
                            ${limit ? `<small class="text-muted ms-2">WIP: ${items.length}/${limit}</small>` : ''}
                        </div>
                        <span class="badge ${exceeded ? 'bg-danger' : 'bg-dark'} text-white rounded-pill px-3 py-1 fw-medium">
                            ${items.length}
                        </span>
                    </div>
                    <div class="drop-zone overflow-y-auto custom-scrollbar" style="min-height: 200px; max-height: calc(100vh - 280px);">
                        ${cardsHtml}
                    </div>
                </div>
            `;
                board.appendChild(col);
            });

            initDragAndDrop();
            initSearch();

        } catch (err) {
            if (quickMetrics) quickMetrics.innerHTML = '';
            if (stageCountCards) stageCountCards.innerHTML = '';
            board.innerHTML = `<div class="alert alert-danger w-100 text-center p-5">Could not load data: ${err.message}</div>`;
        } finally {
            loading.classList.add('d-none');
        }
    }

    // ────────────────────────────────────────────────
    // DRAG & DROP (unchanged)
    // ────────────────────────────────────────────────

    let draggedCard = null;

    function initDragAndDrop() {
        document.querySelectorAll('.kanban-card').forEach(card => {
            card.addEventListener('dragstart', e => {
                draggedCard = card;
                setTimeout(() => card.style.opacity = '0.5', 0);
                e.dataTransfer.effectAllowed = 'move';
            });

            card.addEventListener('dragend', () => {
                setTimeout(() => {
                    if (draggedCard) draggedCard.style.opacity = '1';
                    draggedCard = null;
                }, 100);
                document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('drag-over'));
            });
        });

        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.addEventListener('dragover', e => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                zone.classList.add('drag-over');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });

            zone.addEventListener('drop', async e => {
                e.preventDefault();
                zone.classList.remove('drag-over');

                if (!draggedCard) return;

                const newColumn = zone.closest('.kanban-column');
                const newStageEl = newColumn.querySelector('h5.fw-bold');
                const newStage = newStageEl?.textContent.trim();

                if (!newStage || !STAGES.includes(newStage)) return;

                const itemId = draggedCard.dataset.id;
                if (!itemId) return;

                const activeRole = document.getElementById('userRole') ? document.getElementById('userRole').value : 'Admin';

                try {
                    const res = await fetch(`/workitems/${itemId}/transition`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ target_stage: newStage, user_role: activeRole })
                    });
                    const data = await res.json();

                    if (!res.ok) {
                        if (data.reason && data.reason.toLowerCase().includes("regression")) {
                            document.getElementById('regressionForm').dataset.itemId = itemId;
                            document.getElementById('regressionForm').dataset.targetStage = newStage;
                            new bootstrap.Modal(document.getElementById('regressionModal')).show();
                            return;
                        } else {
                            alert('Cannot move: ' + (data.reason || data.error));
                            loadBoard();
                            return;
                        }
                    }

                    zone.appendChild(draggedCard);
                    updateColumnCounts();
                    loadBoard(); // Reload entirely to refresh colors and badges
                } catch (err) {
                    alert(err.message);
                    loadBoard();
                }
            });
        });
    }

    function updateColumnCounts() {
        document.querySelectorAll('.kanban-column').forEach(col => {
            const badge = col.querySelector('.badge.rounded-pill');
            const count = col.querySelectorAll('.kanban-card').length;
            if (badge) badge.textContent = count;

            const wipText = col.querySelector('small.text-muted');
            if (wipText) {
                const limit = parseInt(wipText.textContent.match(/\/(\d+)/)?.[1] || 0);
                wipText.closest('.d-flex').classList.toggle('text-danger', count > limit);
                col.querySelector('.position-relative').classList.toggle('wip-limit-exceeded', count > limit);
                badge?.classList.toggle('bg-danger', count > limit);
                badge?.classList.toggle('bg-dark', count <= limit);
            }
        });
    }

    // ────────────────────────────────────────────────
    // SEARCH
    // ────────────────────────────────────────────────

    function initSearch() {
        const searchInput = document.getElementById('boardSearch');
        if (!searchInput) return;

        searchInput.addEventListener('input', e => {
            const term = e.target.value.toLowerCase().trim();
            document.querySelectorAll('.kanban-card').forEach(card => {
                const title = card.querySelector('h5')?.textContent.toLowerCase() || '';
                const desc = card.querySelector('p.small')?.textContent.toLowerCase() || '';
                card.style.display = (title.includes(term) || desc.includes(term)) ? '' : 'none';
            });
        });
    }

    // ────────────────────────────────────────────────
    // MODAL HANDLERS
    // ────────────────────────────────────────────────

    let activeModal = null;

    async function openItem(id) {
        console.log(`Opening item ${id}`);
        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

        if (!activeModal) {
            activeModal = new bootstrap.Modal(document.getElementById('itemModal'));
        }
        activeModal.show();

        try {
            const res = await fetch(`/workitems/${id}`);
            if (!res.ok) throw new Error('Failed to fetch details');
            const data = await res.json();

            const historyHtml = data.history.map(h => `<li><small class="text-muted">${new Date(h.timestamp).toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' })} - </small> Moved ${h.from} &rarr; ${h.to} ${h.reason ? `<br><span class="text-danger small">Reason: ${h.reason}</span>` : ''}</li>`).join('');
            const artifactsHtml = data.artifacts.length ? data.artifacts.map(a => `<li><span class="badge bg-secondary mb-1">${a.stage}</span><br><span class="small">${a.type} ${a.reference ? `<a href="${a.reference}" target="_blank" class="ms-1">Ref</a>` : ''}</span></li>`).join('') : '<li class="text-muted small">No artifacts yet</li>';
            const commentsHtml = data.comments.map(c => `<div class="mb-2 p-2 border rounded border-light"><strong class="small">${c.author}</strong> <small class="text-muted">${new Date(c.created_at).toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' })}</small><p class="mb-0 text-dark small mt-1">${c.content}</p></div>`).join('');

            modalContent.innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <h4 class="fw-bold text-dark mb-3">${data.title}</h4>
                    <span class="badge ${priorityColors[data.priority || 'Medium']} mb-2 fw-medium">${data.priority || 'Medium'}</span>
                    <span class="badge bg-light text-dark border mb-2 fw-medium"><span class="material-symbols-outlined fs-6 align-middle me-1">person</span>${data.assignee || 'Unassigned'}</span>
                    <br>
                    <a href="/ui/editor/${data.id}" class="btn btn-outline-dark btn-sm rounded-pill mt-1 fw-bold">
                        <span class="material-symbols-outlined fs-6 align-middle me-1">code</span> Open Workspace
                    </a>
                    <p class="mt-3 text-dark small">${data.description || 'No description provided.'}</p>
                    
                    <hr class="my-4">
                    <h6 class="fw-bold mb-3 d-flex align-items-center"><span class="material-symbols-outlined me-2 text-primary fs-5">forum</span> Discussions</h6>
                    <div class="comments-section mb-3 overflow-y-auto custom-scrollbar" style="max-height: 250px; padding-right: 5px;">
                        ${commentsHtml || '<div class="text-muted small text-center p-3 bg-light rounded">No comments yet. Start the discussion!</div>'}
                    </div>
                    <form onsubmit="addComment(event, ${data.id})" class="d-flex gap-2 mt-2">
                        <input type="text" id="newComment" class="form-control form-control-sm border-secondary-subtle" placeholder="Write a comment..." required>
                        <button type="submit" class="btn btn-sm btn-primary px-3 rounded-pill fw-medium">Post</button>
                    </form>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-light rounded shadow-sm border text-dark h-100">
                        <p class="mb-1 text-muted small fw-bold text-uppercase">Stage</p>
                        <span class="badge bg-${getStageColorClass(data.current_stage)} w-100 py-2 fs-6 mb-3 shadow-sm">${data.current_stage}</span>
                        
                        <p class="mb-1 text-muted small fw-bold text-uppercase">Created</p>
                        <p class="small fw-bold mb-3">${new Date(data.created_at).toLocaleDateString()}</p>
                        
                        <h6 class="mt-4 mb-2 fw-bold text-muted small text-uppercase">History</h6>
                        <ul class="list-unstyled small mb-4">${historyHtml}</ul>
                        
                        <h6 class="mt-4 mb-2 fw-bold text-muted small text-uppercase">Artifacts</h6>
                        <ul class="list-unstyled small mb-0">${artifactsHtml}</ul>
                    </div>
                </div>
            </div>
        `;
        } catch (err) {
            modalContent.innerHTML = `<div class="alert alert-danger shadow-sm border-0 m-3">${err.message}</div>`;
        }
    }

    window.addComment = async function (e, id) {
        e.preventDefault();
        const content = document.getElementById('newComment').value.trim();
        if (!content) return;
        try {
            const res = await fetch(`/workitems/${id}/comment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, author: 'Current User' })
            });
            if (!res.ok) throw new Error('Failed to post comment');
            openItem(id);
        } catch (err) {
            alert(err.message);
        }
    };

    document.getElementById('createForm')?.addEventListener('submit', async e => {
        e.preventDefault();
        const title = document.getElementById('title').value.trim();
        const priority = document.getElementById('priority').value;
        const assignee = document.getElementById('assignee')?.value.trim() || 'Unassigned';
        const desc = document.getElementById('description').value.trim();

        if (!title) return;

        try {
            const res = await fetch('/workitems', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, priority, assignee, description: desc })
            });
            if (!res.ok) throw new Error('Failed to create item');
            bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
            loadBoard();
            document.getElementById('createForm').reset();
        } catch (err) {
            alert(err.message);
        }
    });

    document.getElementById('regressionForm')?.addEventListener('submit', async e => {
        e.preventDefault();
        const reason = document.getElementById('regressionReason').value.trim();
        const itemId = e.target.dataset.itemId;
        const targetStage = e.target.dataset.targetStage;
        const activeRole = document.getElementById('userRole') ? document.getElementById('userRole').value : 'Admin';

        if (reason && itemId && targetStage) {
            try {
                const res = await fetch(`/workitems/${itemId}/transition`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target_stage: targetStage, reason: reason, user_role: activeRole })
                });
                const data = await res.json();
                if (!res.ok) {
                    alert('Regression failed: ' + (data.reason || data.error));
                } else {
                    bootstrap.Modal.getInstance(document.getElementById('regressionModal')).hide();
                    document.getElementById('regressionForm').reset();
                }
                loadBoard();
            } catch (err) {
                alert(err.message);
                loadBoard();
            }
        }
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', loadBoard);
</script>

{% endblock %}