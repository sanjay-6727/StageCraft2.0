{% extends "layout.html" %}
{% block content %}
<link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
<style>
    .CodeMirror {
        height: 600px;
        border-radius: 8px;
        font-family: 'Consolas', 'Monaco', monospace;
    }

    .file-tree {
        max-height: 600px;
        overflow-y: auto;
    }

    .file-item {
        cursor: pointer;
        transition: background 0.2s;
    }

    .file-item:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .file-item.active {
        background-color: rgba(13, 110, 253, 0.1);
        font-weight: 600;
        border-right: 3px solid #0d6efd;
    }

    [data-bs-theme="dark"] .file-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    [data-bs-theme="dark"] .file-item.active {
        background-color: rgba(13, 110, 253, 0.2);
    }
</style>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="fw-bold mb-1 d-flex align-items-center">
                <span class="material-symbols-outlined me-2 fs-3 text-primary">terminal</span>
                Code Workspace: {{ work_item.title }}
            </h3>
            <div class="text-muted small">ID: {{ work_item.public_id }} â€¢ Stage: {{ work_item.current_stage }}</div>
        </div>
        <a href="/ui/board" class="btn btn-outline-secondary rounded-pill px-4">
            <span class="material-symbols-outlined fs-6 align-middle me-1">arrow_back</span> Board
        </a>
    </div>

    <div class="row g-3">
        <!-- Sidebar: Files -->
        <div class="col-md-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold d-flex align-items-center">
                        <span class="material-symbols-outlined fs-5 me-1">folder_open</span> Files Explorer
                    </h6>
                    <button class="btn btn-sm btn-light border rounded" onclick="createNewFile()">
                        <span class="material-symbols-outlined fs-6">add</span>
                    </button>
                </div>
                <div class="card-body p-0 file-tree" id="fileTree">
                    <!-- Files injected via JS -->
                    <div class="p-3 text-center text-muted small" id="noFilesMsg">
                        No files pushed yet. Start coding!
                    </div>
                </div>
            </div>
        </div>

        <!-- Editor panel -->
        <div class="col-md-9">
            <div class="card shadow-sm border-0 h-100">
                <div
                    class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center py-2">
                    <div class="d-flex align-items-center w-50">
                        <span class="material-symbols-outlined fs-5 me-2 text-muted">description</span>
                        <input type="text" id="currentFileName"
                            class="form-control form-control-sm me-2 border-0 fw-bold bg-light"
                            placeholder="e.g. index.js" disabled>
                    </div>
                    <div>
                        <button class="btn btn-success btn-sm px-4 fw-bold rounded-pill shadow-sm" id="pushBtn"
                            onclick="pushChanges()" disabled>
                            <span class="material-symbols-outlined fs-6 align-middle me-1">cloud_upload</span> Push Code
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <textarea id="codeEditor"></textarea>
                </div>
                <div class="card-footer bg-transparent py-2 text-muted small d-flex justify-content-between">
                    <span id="saveStatus">Synced &middot; No unsaved changes</span>
                    <span>Syntax highlighting automatically inferred.</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const workItemId = {{ work_item.id }};
    let editor = null;
    let filesData = [];
    let currentActiveFile = null;

    document.addEventListener("DOMContentLoaded", () => {
        editor = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
            lineNumbers: true,
            mode: "javascript",
            theme: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'dracula' : 'default',
            matchBrackets: true,
            indentUnit: 4
        });

        editor.on('change', () => {
            if (currentActiveFile && editor.getValue() !== currentActiveFile.content) {
                document.getElementById('saveStatus').innerHTML = '<span class="text-warning">Unsaved changes &bull; Pending push</span>';
            }
        });

        loadFiles();
    });

    async function loadFiles() {
        try {
            const res = await fetch(`/workitems/${workItemId}/code`);
            if (!res.ok) throw new Error("Failed to pull files.");
            filesData = await res.json();

            const fileTree = document.getElementById('fileTree');
            if (filesData.length === 0) {
                fileTree.innerHTML = '<div class="p-3 text-center text-muted small" id="noFilesMsg">No files pushed yet. Start coding!</div>';
            } else {
                fileTree.innerHTML = filesData.map(f => `
                    <div class="p-2 px-3 border-bottom file-item d-flex align-items-center" onclick="openFile('${f.filename}')" data-filename="${f.filename}">
                        <span class="material-symbols-outlined fs-5 me-2 text-primary">description</span>
                        <span class="text-truncate small fw-medium">${f.filename}</span>
                    </div>
                `).join('');
            }
        } catch (err) {
            console.error(err);
        }
    }

    function createNewFile() {
        const fname = prompt("Enter new filename (e.g. main.py):");
        if (!fname) return;
        if (filesData.find(f => f.filename === fname)) {
            alert("File already exists!");
            return;
        }

        const newFile = { filename: fname, content: "" };
        filesData.push(newFile);
        openFile(fname, newFile);

        // Re-render tree immediately
        const treeHtml = filesData.map(f => `
            <div class="p-2 px-3 border-bottom file-item d-flex align-items-center" onclick="openFile('${f.filename}')" data-filename="${f.filename}">
                <span class="material-symbols-outlined fs-5 me-2 text-primary">description</span>
                <span class="text-truncate small fw-medium">${f.filename}</span>
            </div>
        `).join('');
        document.getElementById('fileTree').innerHTML = treeHtml;
    }

    function openFile(filename, syntheticFile = null) {
        let f = syntheticFile || filesData.find(x => x.filename === filename);
        if (!f) return;

        currentActiveFile = f;
        document.getElementById('currentFileName').value = f.filename;
        document.getElementById('currentFileName').disabled = false;
        document.getElementById('pushBtn').disabled = false;

        document.querySelectorAll('.file-item').forEach(el => {
            el.classList.toggle('active', el.dataset.filename === filename);
        });

        const ext = filename.split('.').pop().toLowerCase();
        let mode = "javascript";
        if (ext === 'py') mode = "python";
        if (ext === 'html') mode = "htmlmixed";
        if (ext === 'css') mode = "css";

        editor.setOption("mode", mode);
        editor.setValue(f.content || "");

        document.getElementById('saveStatus').innerHTML = 'Synced &middot; No unsaved changes';
    }

    async function pushChanges() {
        if (!currentActiveFile) return;
        const pushBtn = document.getElementById('pushBtn');
        pushBtn.disabled = true;
        pushBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Pushing...';

        const content = editor.getValue();
        const filename = document.getElementById('currentFileName').value.trim();

        if (!filename) {
            alert("Filename cannot be empty.");
            pushBtn.disabled = false;
            pushBtn.innerHTML = '<span class="material-symbols-outlined fs-6 align-middle me-1">cloud_upload</span> Push Code';
            return;
        }

        try {
            const res = await fetch(`/workitems/${workItemId}/code`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ filename, content })
            });

            if (!res.ok) throw new Error("Failed to push code.");

            document.getElementById('saveStatus').innerHTML = '<span class="text-success fw-bold">Pushed successfully!</span>';
            setTimeout(() => document.getElementById('saveStatus').innerHTML = 'Synced', 3000);

            await loadFiles();
            document.querySelectorAll('.file-item').forEach(el => {
                el.classList.toggle('active', el.dataset.filename === filename);
            });
            currentActiveFile = filesData.find(x => x.filename === filename);

        } catch (err) {
            alert(err.message);
        } finally {
            pushBtn.disabled = false;
            pushBtn.innerHTML = '<span class="material-symbols-outlined fs-6 align-middle me-1">cloud_upload</span> Push Code';
        }
    }
</script>
{% endblock %}